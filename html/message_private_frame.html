<!doctype html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="copyright" content="www.apicloud.com" />
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <meta name="format-detection" content="telephone=no" />
    <title>孔孟之道--私信</title>
    <link rel="stylesheet" type="text/css" href="../css/api.css" />
    <style>
        html,
        body {
            min-height: 100%;
            background: #f2f2f2;
        }

        .fr {
            float: right;
        }

        .fl {
            float: left;
        }

        .mt5 {
            margin-top: 5px;
        }

        .mt10 {
            margin-top: 10px;
        }

        .mt15 {
            margin-top: 15px;
        }

        .mt20 {
            margin-top: 20px;
        }

        .ml5 {
            margin-left: 0.5em;
        }

        .mr5 {
            margin-right: 0.5em;
        }

        .hdivider {
            width: 100%;
            height: 1px;
            background-color: #f2f2f2;
        }

        .br {
            border-right: 1px solid #f2f2f2;
        }

        .bb {
            border-bottom: 1px solid #f2f2f2;
            height: 1px;
        }

        .toRight {
            right: 0;
        }

        .row {
            display: -webkit-box;
            display: -webkit-flex;
        }

        .col {
            -webkit-box-flex: 1;
            -webkit-flex: 1;
            flex: 1;
            margin: 0 5px;
            position: relative;
        }

        .swiper-container img {
            width: 100%;
        }
        /* 头部 */

        .nomessage {
            margin-top: 20px;
            font-size: 0.8em;
            text-align: center;
            color: #999;
        }

        section {
            border-top: 1px solid #ccc;
        }

        section>ul {
            margin: 0 10px;
        }

        section ul li {
            width: 100%;
            height: 50px;
            padding: 10px 0;
            border-bottom: 1px solid #ccc;
        }
        /*section ul li:nth-last-child(1){border-bottom: 1px solid #ccc;}*/


        /*.user-img {
            width: 45px;
            height: 50px;
            line-height: 50px;
            display: inline-block;
        }

        .user-img>img {
            width: 45px;
        }

        .user-name {
            height: 50px;
            display: inline-block;
            vertical-align: top;
            position: relative;
            width: 85%;
            border-bottom: 1px solid #ccc;
        }

        .user-name p {
            font-size: 16px;
            color: #535354;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .user-name div .user_name_p2 {
            font-size: 12px;
            color: #999;
        }

        .user-name div .user_name_p1 {
            font-size: 14px;
            width: 100px;
            color: #999;
            word-break: keep-all;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-name div {
            width: 100%;
            height: 25px;
            line-height: 25px;
        }

        .user_name_span {
            position: relative;
        }

        .user_name_span1 {
            width: 90%;
            display: block;
            color: #999;
            font-size: 12px;
        }

        .user_name_span2 {
            display: block;
            width: 20px;
            height: 20px;
            position: absolute;
            top: 0px;
            right: 2.5px;
            background: red;
            border-radius: 10px;
            text-align: center;
            color: #fff;
            font-size: 10px;
            line-height: 20px;
        }*/
        .user-img{width:50px;height: 50px;line-height: 50px;display: inline-block;border-radius: 25px;overflow: hidden;}
        .user-img>img{width: 100%;}
        .user-name{height: 50px;display: inline-block;vertical-align: top;position: relative;width: 83%;margin-left: 2%;
          }
        .user-name p{font-size: 16px;color: #535354;overflow: hidden;text-overflow: ellipsis;white-space:nowrap;}
        .user-name div .user_name_p2{font-size: 12px;color: #999;}
        .user-name div .user_name_p1{font-size: 14px;width:100px;color: #64b3d7; word-break: keep-all;white-space: nowrap; overflow: hidden;text-overflow: ellipsis;}
        .user-name div{width: 100%;height: 25px;line-height: 25px;}
        .user_name_span{position: relative;}
        .user_name_span1{width: 90%;display: block;color: #999;font-size: 12px;}
        .user_name_span2{display: block;position: absolute;top: 0px;right: 2.5px;border-radius: 10px;text-align: center;color: #fff;font-size: 10px;line-height: 20px;}
        .user_name_span2 div{background: red;width: 20px;height: 20px;position: absolute;top: 0px;right: 2.5px;border-radius: 10px;text-align: center;color: #fff;font-size: 10px;line-height: 20px;}
        #footer {
            width: 100%;
            height: 50px;
            line-height: 50px;
            text-align: center;
        }
    </style>
</head>
<body>
<section>
  <ul id="section">

  </ul>
  <div id="footer" class="disnone">
      没有消息
  </div>
</section>
</body>
<script type="text/javascript" src="../script/api.js"></script>
<script type="text/javascript" src="../script/common.js"></script>
<script type="text/javascript" src="../script/message.js"></script>
<script type="text/javascript">
    var token;
    // apiready = function() {
    //     token = $api.getStorage('token');
    //     fnMessagePrivateFrame();
    var p = 1;
    apiready = function (){
      token = $api.getStorage('token');
      fnMessagePrivateFrame();
      api.addEventListener({
          name: 'personalPrivateFrame'
      }, function(ret, err) {
          fnMessagePrivateFrame();
      });

      api.setCustomRefreshHeaderInfo({
          bgColor: '#f0f0f0',
          image: {
              pull: [
                  'widget://image/Refresh/dropdown_anim_00.png',
                  'widget://image/Refresh/dropdown_anim_01.png',
                  'widget://image/Refresh/dropdown_anim_02.png',
                  'widget://image/Refresh/dropdown_anim_03.png',
                  'widget://image/Refresh/dropdown_anim_04.png',
                  'widget://image/Refresh/dropdown_anim_05.png',
                  'widget://image/Refresh/dropdown_anim_06.png',
                  'widget://image/Refresh/dropdown_anim_07.png',
                  'widget://image/Refresh/dropdown_anim_08.png',
                  'widget://image/Refresh/dropdown_anim_09.png',
                  'widget://image/Refresh/dropdown_anim_10.png',
              ],
              load: [
                  'widget://image/Refresh/dropdown_anim_00.png',
                  'widget://image/Refresh/dropdown_anim_01.png',
                  'widget://image/Refresh/dropdown_anim_02.png',
                  'widget://image/Refresh/dropdown_anim_03.png',
                  'widget://image/Refresh/dropdown_anim_04.png',
                  'widget://image/Refresh/dropdown_anim_05.png',

              ]
          }
      }, function() {
          //下拉刷新被触发，自动进入加载状态，使用 api.refreshHeaderLoadDone() 手动结束加载中状态
          //下拉刷新被触发，使用 api.refreshHeaderLoadDone() 结束加载中状态
          fnMessagePrivateFrame();
      });
      api.addEventListener({
          name: 'scrolltobottom',
          extra: {
              threshold: -20 //设置距离底部多少距离时触发，默认值为0，数字类型
          }
      }, function(ret, err) {
          p++;
          fnMessagePrivateFrames();
      });
    }
    // 下拉刷新
    function fnMessagePrivateFrame() {
        var model = api.deviceModel;
      var sVer = api.systemVersion;
      api.ajax({
        url: host + apiUri + '/message/lists',
        method: 'get',
        dataType: 'json',
        timeout:10,
        headers: {
            "source": api.systemType,
            "version": version,
            "session": token,
            "mobile-model": model,
            "os-version": sVer
        },
          data: {
              values: {
                  type: 3,
                  p:1
              }
          }
      },function(ret, err){
          if (ret) {
              // console.log(JSON.stringify(ret));
              if(ret){
              if (ret.status == 200) {
                  api.refreshHeaderLoadDone();
                  if (p == 1) {
                      if (ret.data.list == "") {
                        var footer = $api.byId('footer');
                        $api.html(footer, '暂无私信');
                      }else if (!ret.data.list == '' && ret.data.list.length < 8  ) {
                        var footer = $api.byId('footer');
                        $api.html(footer, '');
                      }
                  } else {
                      if (ret.data.list == '') {
                          var footer = $api.byId('footer');
                          $api.html(footer, '没有更多结果了');
                      } else {
                              var footer = $api.byId('footer');
                              $api.html(footer, '上拉加载更多');

                      }
                  }

                // if(ret.data.list.length>=10){
                //   var footer = $api.byId('footer');
                //   $api.html(footer, '上拉加载更多');
                // }else{
                //   var footer = $api.byId('footer');
                //   $api.html(footer, '无更多消息');
                // }
                // if(!ret.data.list){
                //   var footer = $api.byId('footer');
                //   $api.html(footer, '没有消息');
                // }
                api.refreshHeaderLoadDone()
                // console.log(JSON.stringify(ret));
                var html = '';
                var section = $api.byId('section');
                for (var i = 0; i < ret.data.list.length; i++) {
                    // console.log(1);
                    // console.log(ret.data.list[i].content);
                    var listening_cover = ret.data.list[i].friend_img;
                    var sandBox = listening_cover.substring(0, 4);
                    if (sandBox == 'http') {
                        images = ret.data.list[i].friend_img;
                    }else {
                      images = updatePhotoUrl + listening_cover;
                    }
                    // function timestampToTime(timestamp) {
                    //     var date = new Date(timestamp * 1000);//时间戳为10位需*1000，时间戳为13位的话不需乘1000
                    //     Y = date.getFullYear() + '年';
                    //     M = (date.getMonth()+1 < 10 ? '0'+(date.getMonth()+1) : date.getMonth()+1) + '月';
                    //     D = date.getDate() + '日';
                    //     return Y+M+D;
                    // }
                    var timestampToTimess = timetrans(ret.data.list[i].modify_date);
                    function timetrans(date){
                          var date = new Date(date*1000);//如果date为13位不需要乘1000
                          var Y = date.getFullYear() + '年';
                          var M = (date.getMonth()+1 < 10 ? '0'+(date.getMonth()+1) : date.getMonth()+1) + '月';
                          var D = (date.getDate() < 10 ? '0' + (date.getDate()) : date.getDate()) + '日';
                          var h = (date.getHours() < 10 ? '0' + date.getHours() : date.getHours()) + ':';
                          var m = (date.getMinutes() <10 ? '0' + date.getMinutes() : date.getMinutes()) + ':';
                          var s = (date.getSeconds() <10 ? '0' + date.getSeconds() : date.getSeconds());
                          return Y+M+D+' '+h+m+s;
                      }

                    // var timestampToTimess =  timestampToTime(ret.data.list[i].modify_date);
                    // console.log(timestampToTimess);
                    var time = timestampToTimess;

                    // 时间统一函数
                    function getTimeText(argument) {
                        var timeS = argument;
                        var todayT = ''; //
                        var yestodayT = '';
                        var timeCha = getTimeS(timeS);
                        timeS = timeS.slice(-8);
                        todayT = new Date().getHours()*60*60*1000 + new Date().getMinutes()*60*1000 + new Date().getSeconds()*1000;
                        yestodayT = todayT + 24*60*60*1000;
                        if(timeCha > yestodayT) {
                            return argument.slice(0,11);
                        }
                        if(timeCha > todayT && timeCha < yestodayT) {
                            return '昨天'+timeS.slice(0,5);
                        }
                        if(timeCha < todayT) {
                            return timeS.slice(0,5);
                        }
                    }
                    // 时间戳获取
                    function getTimeS(argument) {
                        var timeS = argument;
                        timeS = timeS.replace(/[年月]/g,'/').replace(/[日]/,'');
                        return new Date().getTime() - new Date(timeS).getTime() - 1000; //有一秒的误差
                    }
                    var timeText = getTimeText(time);
                    // console.log(timeText);

                    // console.log(timeText);

                    var unread_nums;
                    // console.log(ret.data.list[i].unread_nums);
                    if (ret.data.list[i].unread_nums != 0) {
                        unread_nums = '<div>'+ret.data.list[i].unread_nums+'</div>'
                    }else {
                        unread_nums = ''
                    }
                    html += '<li onclick="fnOpenprivate('+ret.data.list[i].friend_id+',\''+ret.data.list[i].friend_name+'\')">'+
                          '<div class="user-img"><img src="'+images+'" alt=""></div>'+
                          '<div class="user-name">'+
                            '<div>'+
                              '<p class="fl user_name_p1">'+ret.data.list[i].friend_name+'</p>'+
                              '<p class="fr user_name_p2">'+timeText+'</p>'+
                            '</div>'+
                            '<div class="user_name_span">'+
                              '<span class="user_name_span1">'+ret.data.list[i].content+'</span>'+
                              '<span class="user_name_span2" id="user_name_span2">'+unread_nums+'</span>'+
                            '</div>'+
                          '</div>'+
                        '</li>'
                }
                $api.html(section, html);
              }
          } else {
            api.refreshHeaderLoadDone();
              netMessage(ret);
          }
        }else{
          api.refreshHeaderLoadDone();
          netWork(err);
        }
      });

    }
    // 上拉加载更多
    function fnMessagePrivateFrames() {
        var model = api.deviceModel;
      var sVer = api.systemVersion;
      api.ajax({
        url: host + apiUri + '/message/lists',
        method: 'get',
        dataType: 'json',
        timeout:10,
        headers: {
            "source": api.systemType,
            "version": version,
            "session": token,
            "mobile-model": model,
              "os-version": sVer
        },
          data: {
              values: {
                  type: 3,
                  p:p
              }
          }
      },function(ret, err){
          if (ret) {
              if(ret){
              if (ret.status == 200) {
                if (p == 1) {
                    if (ret.data.list == "") {
                      var footer = $api.byId('footer');
                      $api.html(footer, '暂无私信');
                    }else if (!ret.data.list == '' && ret.data.list.length < 8  ) {
                      var footer = $api.byId('footer');
                      $api.html(footer, '');
                    }
                } else {
                    if (ret.data.list == '') {
                        var footer = $api.byId('footer');
                        $api.html(footer, '没有更多结果了');
                    } else {
                            var footer = $api.byId('footer');
                            $api.html(footer, '上拉加载更多');

                    }
                }
                // console.log(JSON.stringify(ret));
                if (ret.data.list) {
                  var section = $api.byId('section');
                  for (var i = 0; i < ret.data.list.length; i++) {
                    var footer = $api.byId('footer');
                    $api.html(footer, '上拉加载更多');
                      // console.log(1);
                      // console.log(ret.data.list[i].content);
                      var listening_cover = ret.data.list[i].friend_img;
                      var sandBox = listening_cover.substring(0, 4);
                      if (sandBox == 'http') {
                          images = ret.data.list[i].friend_img;
                      }else {
                        images = updatePhotoUrl + listening_cover;
                      }
                      function timetrans(date){
                            var date = new Date(date*1000);//如果date为13位不需要乘1000
                            var Y = date.getFullYear() + '年';
                            var M = (date.getMonth()+1 < 10 ? '0'+(date.getMonth()+1) : date.getMonth()+1) + '月';
                            var D = (date.getDate() < 10 ? '0' + (date.getDate()) : date.getDate()) + '日';
                            var h = (date.getHours() < 10 ? '0' + date.getHours() : date.getHours()) + ':';
                            var m = (date.getMinutes() <10 ? '0' + date.getMinutes() : date.getMinutes()) + ':';
                            var s = (date.getSeconds() <10 ? '0' + date.getSeconds() : date.getSeconds());
                            return Y+M+D+h+m+s;
                        }
                      var timestampToTimess = timetrans(ret.data.list[i].modify_date);
                      // var timestampToTimess =  timestampToTime(ret.data.list[i].modify_date);
                      console.log(timestampToTimess);
                      var time = timestampToTimess;
                      console.log(time);
                      // 时间统一函数
                      function getTimeText(argument) {
                          var timeS = argument;
                          var todayT = ''; //
                          var yestodayT = '';
                          var timeCha = getTimeS(timeS);
                          timeS = timeS.slice(-8);
                          todayT = new Date().getHours()*60*60*1000 + new Date().getMinutes()*60*1000 + new Date().getSeconds()*1000;
                          yestodayT = todayT + 24*60*60*1000;
                          if(timeCha > yestodayT) {
                              return argument.slice(0,11);
                          }
                          if(timeCha > todayT && timeCha < yestodayT) {
                              return '昨天'+timeS.slice(0,5);
                          }
                          if(timeCha < todayT) {
                              return timeS.slice(0,5);
                          }
                      }
                      // 时间戳获取
                      function getTimeS(argument) {
                          var timeS = argument;
                          timeS = timeS.replace(/[年月]/g,'/').replace(/[日]/,'');
                          return new Date().getTime() - new Date(timeS).getTime() - 1000; //有一秒的误差
                      }
                      var timeText = getTimeText(time);
                      var unread_nums;
                      // console.log(ret.data.list[i].unread_nums);
                      if (ret.data.list[i].unread_nums != 0) {
                          unread_nums = '<div>'+ret.data.list[i].unread_nums+'</div>'
                      }else {
                          unread_nums = ''
                      }
                      // if (ret.data.list == '') {

                      // } else {
                      //     if (ret.data.list.length < 10) {
                      //         var footer = $api.byId('footer');
                      //         $api.html(footer, '无更多数据');
                      //     } else {
                      //         var footer = $api.byId('footer');
                      //         $api.html(footer, '正在加载更多');
                      //     }
                            $api.append(section,'<li onclick="fnOpenprivate('+ret.data.list[i].friend_id+',\''+ret.data.list[i].friend_name+'\')">'+
                                  '<div class="user-img"><img src="'+images+'" alt=""></div>'+
                                  '<div class="user-name">'+
                                    '<div>'+
                                      '<p class="fl user_name_p1">'+ret.data.list[i].friend_name+'</p>'+
                                      '<p class="fr user_name_p2">'+timeText+'</p>'+
                                    '</div>'+
                                    '<div class="user_name_span">'+
                                      '<span class="user_name_span1">'+ret.data.list[i].content+'</span>'+
                                      '<span class="user_name_span2" id="user_name_span2">'+unread_nums+'</span>'+
                                    '</div>'+
                                  '</div>'+
                                '</li>');


                        // }
                  }
                }else {
                      var footer = $api.byId('footer');
                      $api.html(footer, '无更多数据');

                }


              }
          } else {
              netMessage(ret);
          }
        }else{
          netWork(err);
        }
      });

    }
  //打开聊天页面
  function fnOpenprivate(userId,nickName){
    api.openWin({
      name: 'personalPrivate',
      url: './personal_private.html',
        pageParam: {
            userId: userId,
            nickName:nickName,
            ok:'personal_private'
        }
    });

  }
</script>
</html>
