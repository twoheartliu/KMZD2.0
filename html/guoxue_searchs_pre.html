<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <title>国学馆搜索前</title>
    <link rel="stylesheet" type="text/css" href="../css/api.css" />
    <style>
        body,
        html {
            background-color: #f2f2f2;
        }
        /*头部样式*/

        header {
            background-color: #89211b;
            height: 50px;
            position: relative;
        }

        .egret-img {
            /*position: absolute;*/
            display: inline-block;
        }

        .egret-img img {
            width: 15px;
            height: 20px;
            padding: 15px;
        }

        .egret-header-search {
            background-color: #f2f2f2;
            width: 68%;
            height: 40px;
            margin-top: 8px;
            border-radius: 4px;
            display: inline-block;
            margin: 5px auto 0;
            vertical-align: top;
            text-align: center;
        }

        .egret-header-search img {
            padding-left: 5px;
            height: 20px;
            margin-top: 10px;
        }

        .egret-header-search input {
            /*height: 20px;*/
            line-height: 18px;
            font-size: 15px;
            padding-top: 10px;
            /*color: #ccc;*/
            vertical-align: top;
        }

        .soso {
            font-size: 18px;
            height: 50px;
            width: 56px;
            float: right;
            line-height: 50px;
            color: white;
        }

        .egret-header-search input:focus {
            /*border:0;*/
            outline: none;
        }

        .itemlist {
            padding-left: 15px;
            width: 91%;
            /*display: block;*/
            margin: 10px;
        }

        .item {
            padding: 8px;
            margin: 2px;
            line-height: 22px;
            border: 1px solid #ccc;
            display: inline-block;
            border-top-right-radius: 10px;
            border-top-left-radius: 10px;
            border-bottom-left-radius: 10px;
            border-bottom-right-radius: 10px;
            background-color: white;
        }

        .search_list {
            /*display: block;*/
            position: relative;
            padding: 10px;
            background-color: white;
        }

        .search {
            line-height: 25px;
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }

        .search img {
            line-height: 25px;
            height: 15px;
            padding-top: 4px;
            position: absolute;
            right: 12px;
        }

        .hot {
            display: block;
            position: relative;
            line-height: 15px;
            padding: 10px;
            font-size: 12px;
            background-color: white;
        }

        .middle {
            height: 30px;
            background-color: #fff;
            padding-top: 22px;
        }

        .so_head {
            display: inline;
            float: left;
            padding-left: 10px;
        }

        .deleteAll {
            display: inline;
            float: right;
            padding-right: 10px;
        }
        /*.clr{clear: both;}*/

        #messageFrameDiv {
            overflow: auto;
        }
    </style>
</head>

<body id='body'>
    <!-- 头部 -->
    <header id="headerss">
        <div class="egret-img"><img src="../image/icon_back.png" alt="" onclick="goback()"></div>
        <div class="egret-header-search" tapmode>
            <img src="../image/header_search.png" alt="">
            <input id='search-input' type="text" placeholder="请输入关键词搜索">
            <!-- <span>请输入关键词搜索</span> -->
        </div>
        <div class="soso" id="soso">搜索</div>
    </header>
    <div id="messageFrameDiv">
        <div class="hot">
            热门搜索
        </div>
        <ul class="itemlist" id="id-hotlist">
            <!-- <li class="item">西游记</li> -->
            <!-- <li class="item">论语</li>
            <li class="item">非常非常好看的国学课</li>
            <li class="item">非常非常好看的国学课</li>
            <li class="item">三字经</li>
            <li class="item">格列佛游记</li>
            <li class="item">非常非常好看的国学课</li>
            <li class="item">三字经</li>
            <li class="item">西游记</li>
            <li class="item">论语</li>
            <li class="item">格列佛游记</li> -->
        </ul>
        <div class="clr"></div>

        <div class="middle">
            <div class="so_head">
                搜索历史
            </div>
            <div class="deleteAll" onclick="deleteAll()">
                清空记录
            </div>
        </div>

        <ul class="search_list" id="id-history">
            <!-- <li class="search">论语 <img src="../image/delete.png" alt=""></li>
            <li class="search">格列佛游记 <img src="../image/delete.png" alt=""></li>
            <li class="search">非常非常好看的国学课 <img src="../image/delete.png" alt=""></li>
            <li class="search">非常非常好看的国学课 <img src="../image/delete.png" alt=""></li>
            <li class="search">三字经 <img src="../image/delete.png" alt=""></li>
            <li class="search">西游记 <img src="../image/delete.png" alt=""></li>
            <li class="search">三字经 <img src="../image/delete.png" alt=""></li>
            <li class="search">西游记 <img src="../image/delete.png" alt=""></li>
            <li class="search">论语 <img src="../image/delete.png" alt=""></li>
            <li class="search">格列佛游记 <img src="../image/delete.png" alt=""></li> -->
        </ul>
    </div>

</body>
<script type="text/javascript" src="../script/api.js"></script>
<script type="text/javascript" src="../script/common.js"></script>
<script type="text/javascript">
    var token;

    function goback() {
        api.closeWin({
            name: 'guoxue_searchs_pre',
        });
    }

    var es = function(selector) {
        var elements = document.querySelectorAll(selector)
        if (elements.length == 0) {
            var s = ''
                // alert(s)
        } else {
            return elements
        }
    }

    var bindEvent = function(element, eventName, callback) {
        element.addEventListener(eventName, callback)
    }

    var bindAll = function(selector, eventName, callback) {
        var elements = es(selector)
        for (var i = 0; i < elements.length; i++) {
            var e = elements[i]
            bindEvent(e, eventName, callback)
        }
    }

    apiready = function() {
        token = $api.getStorage('token');
        var eHeader = $api.byId('headerss')
        var headers = $api.offset(eHeader);
        // var headerssx = $api.offset(eHeader).h;
        // console.log(headers.h);

        $api.fixStatusBar(eHeader);
        // console.log(headers.h);
        if (window.innerHeight)
            winHeight = window.innerHeight;
        else if ((document.body) && (document.body.clientHeight))
            winHeight = document.body.clientHeight;
        var messageFrameDiv = $api.byId('messageFrameDiv');
        var winHeightHeader = winHeight - headers.h - 25;
        $api.css(messageFrameDiv, 'height:' + winHeightHeader + 'px;');

        api.addEventListener({
            name: 'inputValues'
        }, function(ret, err){
            if( ret ){
                var after = ret.value.inputValues
                saveHistory(after)
                //  console.log(JSON.stringify(ret.value.inputValues));
            }else{
                //  alert( JSON.stringify( err ) );
            }
        });


        clearInput();
        ShowHot();

        // localStorage 相关


        // 定义一个数组, 用来存储
        historys = loadHistory();
        insertHistory(historys);

        OpenSearch();

    };

    function openHistory(result) {
        api.openWin({
            name: 'guoxue_searchs',
            url: './guoxue_searchs.html',
            pageParam: {
                data: result,
            }
        });
    }

    function ShowHot() {
        api.ajax({
            url: host + apiUri + '/search/hot',
            method: 'get',
            dataType: 'json',
            timeout: 10,
            headers: {
                "source": api.systemType,
                "version": version,
                "session": token,
            },
            data: {
                values: {
                    type: 'sinology',
                },
            },
        },function(ret, err){
            if (ret) {
                if (ret.status == 200) {
                    var words = '';
                    // console.log(JSON.stringify( ret ) );
                    var hotlist = $api.byId('id-hotlist');
                    for (var i = 0; i < ret.data.length; i++) {
                        var data = ret.data[i];
                        // console.log(JSON.stringify(data));
                        var hotword = data.keyword;
                        // console.log(JSON.stringify(hotword));
                        words = '<li class="item">' + hotword + '</li>';
                        // `<li class="item">${hotword}</li>`;
                        // words += '<li class="item">' + hotword + '</li>';
                        hotlist.insertAdjacentHTML('beforeend', words);
                    }

                    // $api.html(hotlist, words);
                    // console.log(words);
                    bindAll('.item', 'click', function(event) {
                        var self = event.target;
                        // console.log(self);
                        var clicks = self.innerHTML;
                        saveHistory(clicks);


                        // var c = choiceSave(clicks);
                        // console.log(c);


                        api.openWin({
                            name: 'guoxue_searchs',
                            url: './guoxue_searchs.html',
                            pageParam: {
                                data: clicks,
                            }
                        });
                    })
                }
                // alert( JSON.stringify( ret ) );
            } else {
                alert(JSON.stringify(err));
            }
        });

    }

    var templateHistory = function(history) {
        // console.log('111');
        if (history !== '') {
            // console.log('222');
            var t = '<li class="search"><div class="searchs" onclick="openHistory(\'' + history + '\')">' + history + '</div> <img onclick="toDelete()" src="../image/delete.png" alt=""></li>';

            return t
        }
    }

    // 载入历史记录 完成
    function loadHistory() {
        // console.log('was');
        var s = localStorage.guoxueHistory;
        // console.log(s);
        if (s == null) {
            return []
        } else {
            var t = JSON.parse(s)
                // console.log(t);
            return t
        }
    }

    // 把所有 历史记录 插入到页面中
    var insertHistory = function(historys) {
        // 添加到 container 中
        var container = $api.byId('id-history');
        // console.log('wwww');
        for (var i = 0; i < historys.length; i++) {
            var history = historys[i]
            var html = templateHistory(history);
            container.insertAdjacentHTML('afterbegin', html);
        }
    }

    // 历史记录保存到 localStorage
    var saveHistory = function(word) {
        // console.log('saveHistory in');
        // var historys = []
        // console.log(word);
        var container = $api.byId('id-history');
        for (var i = 0; i < historys.length; i++) {
            if (word == historys[i]) {
                historys.splice(i,1);
            }
        }


        if (historys.length > 6) {
            historys = historys.slice(1)
        }
        historys.push(word);
            // console.log('save');
            // console.log(historys);
        var s = JSON.stringify(historys);
        localStorage.guoxueHistory = s;

        // var html = templateHistory(word);
        // container.insertAdjacentHTML('afterbegin', html)
        var container = $api.byId('id-history');
        $api.html(container, '');
        historys = loadHistory();
        insertHistory(historys);

    }

    // 开始搜索并且记录搜索历史
    function OpenSearch() {
        // console.log(searching);
        var so = $api.byId('soso');
        so.addEventListener('click', function(event) {
            // console.log('clicked');
            var w = $api.byId('search-input');
            word = w.value;
            // console.log(word);

            if (word !== '') {
                saveHistory(word);

                api.openWin({
                    name: 'guoxue_searchs',
                    url: './guoxue_searchs.html',
                    pageParam: {
                        data: word,
                    }
                });

            } else {
                api.toast({
                    msg: '请输入要搜索的内容',
                    duration: 2000,
                    location: 'middle'
                });
            }
        })
    }

    var deleteHistory = function(container, historyCell) {
        // 1. 找到在 container 里面的下标
        for (var i = 0; i < container.children.length; i++) {

            var cell = container.children[i]
                // console.log(cell);
            if (cell === historyCell) {
                // 1. 删除这个 cell dom
                historyCell.remove()
                    // 2. 删除保存在 localStorage 里面的对应下标的数据
                var his = loadHistory()
                    // 删除数组中的指定下标元素的方法如下(记住就好)
                    // splice 函数可以删除数组的某一个下标, 第一个参数是要删除的元素的下标
                    // 第二个参数是要删除的元素的个数, 这里只删除一个, 所以这里是 1
                his.splice(i, 1)
                // console.log(i);

                    // 删除后, 保存到 localStorage
                var s = JSON.stringify(his)
                localStorage.guoxueHistory = s
                    // console.log(localStorage.savedHistory);
            }
        }
    }

    function toDelete() {
        // console.log('wads');
        var history = $api.byId('id-history');
        // 通过 event.target 的 class 来检查点击的是什么
        // console.log('sss');
        history.addEventListener('click', function(event) {
            // console.log('ssss');
            var target = event.target
            var Div = target.parentElement
            var hist = $api.byId('id-history');
            deleteHistory(hist, Div);
            // console.log(historys);

        })
    }

    // 清空所有历史记录
    function deleteAll() {
        var dialogBox = api.require('dialogBox');
        dialogBox.alert({
            texts: {
                content: '确定要删除吗？',
                leftBtnTitle: '取消',
                rightBtnTitle: '确认'
            },
            styles: {
                bg: '#fff',
                w: 300,
                content: {
                    color: '#000',
                    size: 14
                },
                left: {
                    marginB: 15,
                    marginL: 20,
                    w: 100,
                    h: 35,
                    corner: 2,
                    bg: '#ccc',
                    color: '#fff',
                    size: 12
                },
                right: {
                    marginB: 15,
                    marginL: 60,
                    w: 100,
                    h: 35,
                    corner: 2,
                    bg: '#ccc',
                    color: '#fff',
                    size: 12
                }
            }
        }, function(ret) {
            if (ret.eventType == 'right') {
                var history = $api.byId('id-history');
                while (history.firstChild) {
                    history.removeChild(history.firstChild);
                }

                localStorage.removeItem('guoxueHistory');
                historys = loadHistory();
                insertHistory(historys);

                var dialogBox = api.require('dialogBox');
                dialogBox.close({
                    dialogName: 'alert'
                });
            } else if (ret.eventType == 'left') {
                var dialogBox = api.require('dialogBox');
                dialogBox.close({
                    dialogName: 'alert'
                });
            }
        });

    }

    function clearInput() {
        api.addEventListener({
            name: 'clearInput'
        }, function(ret, err) {
            if (ret) {
                //  alert( JSON.stringify( ret ) );
                // console.log('sss');
                var input = $api.byId('search-input');
                // console.log(input.value);
                input.value = ""
            } else {
                alert(JSON.stringify(err));
            }
        });

    }
</script>

</html>
