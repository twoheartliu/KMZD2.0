<!doctype html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="copyright" content="www.apicloud.com" />
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <meta name="format-detection" content="telephone=no" />
    <title>孔孟之道--单曲评论详情</title>
    <link rel="stylesheet" type="text/css" href="../css/api.css" />
    <style>
        html,
        body {
            min-height: 100%;
            background: #ebebeb;
        }

        .fr {
            float: right;
        }

        .fl {
            float: left;
        }

        .clear {
            clear: both;
        }

        .mt5 {
            margin-top: 5px;
        }

        .mt10 {
            margin-top: 10px;
        }

        .mt15 {
            margin-top: 15px;
        }

        .mt20 {
            margin-top: 20px;
        }

        .ml5 {
            margin-left: 0.5em;
        }

        .mr5 {
            margin-right: 0.5em;
        }

        .hdivider {
            width: 100%;
            height: 1px;
            background-color: #e0e0e0;
        }

        .br {
            border-right: 1px solid #e0e0e0;
        }

        .bb {
            border-bottom: 1px solid #e0e0e0;
            height: 1px;
        }

        .toRight {
            right: 0;
        }

        .row {
            display: -webkit-box;
            display: -webkit-flex;
        }

        .col {
            -webkit-box-flex: 1;
            -webkit-flex: 1;
            flex: 1;
            margin: 0 5px;
            position: relative;
        }

        .swiper-container img {
            width: 100%;
        }
        /* 头部 */

        .nomessage {
            margin-top: 20px;
            font-size: 0.8em;
            text-align: center;
            color: #999;
        }
        /*中间内容*/

        nav {
            height: 70px;
            padding: 8px;
            background-color: #fff;
        }

        .nav-left .nav-img {
            display: inline-block;
            width: 70px;
            height: 70px;
        }

        .nav-img img {
            width: 100%;
        }

        .nav-left .nav-txt {
            display: inline-block;
            vertical-align: top;
            width: 200px;
            line-height: 25px;
            overflow: hidden;
            margin-left: 10px;
        }

        .nav-right {
            line-height: 65px;
            font-size: 32px;
            color: #666;
        }

        .nav-tit {
            height: 32px;
            padding-left: 8px;
            line-height: 32px;
        }

        .nav-txt {
            color: #535354;
            font-size: 14px;
        }

        .nav-txt>p {
            color: #535354;
            font-size: 14px;
        }

        .nav-txt>p: nth-child(2) {
            color: #ccc;
            font-size: 13px;
        }

        .sec-tit {
            height: 40px;
            line-height: 40px;
            padding-left: 8px;
        }

        .sec-discuss {
            background-color: #fff;
            padding: 8px;
            border-bottom: 3px solid #e0e0e0;
        }

        .sec-img {
            display: inline-block;
            vertical-align: top;
            width: 45px;
            height: 45px;
            border-radius: 22.5px;
            overflow: hidden;
        }

        .sec-img img {
            width: 45px;
            height: 45px;
        }

        .sec-txt {
            display: inline-block;
            padding: 0 0 0 10px;
        }

        .sec-txt>p {
            color: #999;
            line-height: 25px;
        }

        .sec-txt>p:nth-child(2) {
            color: #ccc;
            font-size: 13px;
        }

        .dis-right>div {
            color: #ccc;
            font-size: 14px;
        }

        .dis-right {
            padding-top: 10px;
        }

        .dis-right img {
            width: 16px;
            height: 16px;
            vertical-align: top;
        }

        .dis-txt {
            margin-left: 45px;
            padding-bottom: 10px;
            color: #535354;
            padding: 0 0 0 10px;
        }

        .discuss {
            margin-left: 45px;
            height: auto;
            padding: 10px;
            background-color: #f2f2f3;
            color: #999;
            border-radius: 5px;
        }

        .reply {
            width: 100%;
            height: 20px;
            line-height: 20px;
            text-align: right;
            color: #ccc;
            font-size: 14px;
            padding-right: 10px;
            margin-bottom: 5px;
        }

        .collectmusicFxs {
            width: 25px;
        }

        .collectmusicFxs img {
            width: 100%;
        }

        .nav-txt_name {
            font-size: 12px;
            /*text-indent: 1rem;*/
            font-weight: 600;
        }

        .nav-txt_p {
            font-size: 10px;
            /*text-indent: 1rem;*/
        }

        .h50px {
            width: 100%;
            height: 150px;
        }
    </style>
</head>

<body>
    <div id="container">
        <nav id="details">
            <div class="nav-left fl" onclick="">
                <!-- <div class="nav-img"><img src="../image/index/pic.jpg" alt=""></div>
                <div class="nav-txt">
                </div> -->
            </div>
            <div class="clear"></div>
        </nav>
        <section id="section">
            <div class="sec-tit" id="allcommentS">所有评论</div>

            <div id="comments">
                <!-- <div class="dis-left fl">
                    <div class="sec-img"><img src="../image/icon-person.png" alt=""></div>
                    <div class="sec-txt">
                        <p>燕赵门</p>
                        <p>2017年9月19日</p>
                    </div>
                </div>
                <div class="dis-right fr">
                    <span>3</span><img src="../image/KM_ListingsListDzs.png" alt="" class="zan01">
                </div>
                <div class="clear"></div>
                <div class="dis-txt">海中月是天上月，眼前人是心上人。向来心是看客心，奈何人是剧中人</div>
                <div class="reply" onclick="fnOpenMessageNotDetail()">回复</div>
                <div class="discuss">
                    <span>评论：不知道为什么分开，很多喜欢以为永远会喜欢，到最后才发现任何事情都抵不过时过境迁。</span>
                </div> -->
            </div>
            <div class="h50px"></div>
        </section>
    </div>
    <!-- <div class="nomessage">暂无消息02</div> -->
</body>
<script type="text/javascript" src="../script/api.js"></script>
<script type="text/javascript" src="../script/common.js"></script>
<script type="text/javascript" src="../script/message.js"></script>
<script type="text/javascript">
    function goback() {
        api.closeWin({
            name: 'discussNoticeDetailFrame0'
        });
    }
    var token;
    var soundId;
    var uris;
    var name;
    var commentaAlbumGoodHtml;
    var commentExtraGoods;
    var albumCover;
    apiready = function() {
            token = $api.getStorage('token');
            soundId = api.pageParam.soundId;
            uris = api.pageParam.uris;
            api.addEventListener({
                name: 'singleCover'
            }, function(ret, err) {
                if (ret) {
                    alert(ret)
                        //  console.log( JSON.stringify( ret ) );
                } else {
                    alert(JSON.stringify(err));
                }
            });
            // var tail = albumCover.slice(-4)
            // console.log(tail);
            // if (tail == 'null') {
            // albumCover = '../image/my/fnShareImg.jpg'
            // } else {
            // albumCover = albumCover
            // }
            // console.log(albumCover);
            // name = api.pageParam.name;
            ListenToTheListOfComments();
            fnDetails(soundId);
            api.addEventListener({
                name: 'gengXinSingle'
            }, function(ret, err) {

                ListenToTheListOfComments();
            });

            api.setCustomRefreshHeaderInfo({
                bgColor: '#f0f0f0',
                image: {
                    pull: [
                        'widget://image/Refresh/dropdown_anim_00.png',
                        'widget://image/Refresh/dropdown_anim_01.png',
                        'widget://image/Refresh/dropdown_anim_02.png',
                        'widget://image/Refresh/dropdown_anim_03.png',
                        'widget://image/Refresh/dropdown_anim_04.png',
                        'widget://image/Refresh/dropdown_anim_05.png',
                        'widget://image/Refresh/dropdown_anim_06.png',
                        'widget://image/Refresh/dropdown_anim_07.png',
                        'widget://image/Refresh/dropdown_anim_08.png',
                        'widget://image/Refresh/dropdown_anim_09.png',
                        'widget://image/Refresh/dropdown_anim_10.png',
                    ],
                    load: [
                        'widget://image/Refresh/dropdown_loading_00.png',
                        'widget://image/Refresh/dropdown_loading_01.png',
                        'widget://image/Refresh/dropdown_loading_02.png'
                    ]
                }
            }, function() {
                //下拉刷新被触发，自动进入加载状态，使用 api.refreshHeaderLoadDone() 手动结束加载中状态
                //下拉刷新被触发，使用 api.refreshHeaderLoadDone() 结束加载中状态
                fnDetails(soundId);
                ListenToTheListOfComments();
            });
        }
        //个人主页
    function fnOpenmyPersonal(id, nickname) {
        api.openWin({
            name: 'myPersonal',
            url: './my_personal.html',
            pageParam: {
                userId: id,
                nickName: nickname,
                ok: 'myPersonals'
            },
        });
    };

    function fnDetails(soundId) {
        var uri = '/sound/';
        api.ajax({
            url: host + apiUri + uri + soundId,
            method: 'get',
            dataType: 'json',
            timeout: 10,
            headers: {
                "source": api.systemType,
                "version": version,
                "session": token
            }
        }, function(ret, err) {
            // console.log(JSON.stringify(ret));
            if (ret) {
                if (ret.status == 200) {

                    var stylelist = $api.byId('details');
                    var html = '';
                    var totalCovers = host + '/' + ret.data.cover_mid;
                    var cover = '../image/single.png'
                    var newCover;
                    if (totalCovers.slice(-4) == 'null') {
                        newCover = cover;
                    } else {
                        newCover = totalCovers;
                    }

                    var reciter = ret.data.reciter ? '朗诵者：' + ret.data.reciter : '';
                    var author = ret.data.author_name ? '作者：' + ret.data.author_name : '';
                    // console.log(newCover);
                    html =
                        '  <div class="nav-left fl"  onclick="fnPlayHTML(' + ret.data.id + ');">' +
                        '<div class="nav-img"><img src="' + newCover + '" alt=""></div>' +
                        '<div class="nav-txt">' +
                        '<p class="nav-txt_name">' + ret.data.title + '</p>' +
                        '<p class="nav-txt_p">' + author + '</p> ' + '<p class="nav-txt_p">' + reciter + '</p> '
                    '</div>' +
                    '  </div>' +
                    '<div class="clear"></div>'

                    $api.html(stylelist, html);
                } else {
                    netMessage(ret);

                }
            } else {
                netWork(err);
            }
        });
    }

    function fnPlayHTML(id) {
        api.openWin({
            name: 'playDanQu',
            url: './playDanQu.html',
            pageParam: {
                a: id,
                ok: 'playDanQu'
            }
        });

    }

    function ListenToTheListOfComments() {
        soundId = api.pageParam.soundId;
        name = api.pageParam.name;
        uris = api.pageParam.uris;
        api.ajax({
            url: host + apiUri + uris + soundId,
            method: 'get',
            dataType: 'json',
            timeout: 10,
            headers: {
                "source": api.systemType,
                "version": version,
                "session": token
            }
        }, function(ret, err) {
            if (ret) {
                if (ret.status == 200) {
                    api.refreshHeaderLoadDone();
                    if (ret.data == '') {
                        var stylelist = $api.byId('allcommentS');
                        var html = '暂无评论,<span style="color:blue;" onclick="ReplyToCommentsDiscuss_detail()">去评论</span>';
                        $api.html(stylelist, html);
                    } else {
                        // setTimeout(function(){
                        api.refreshHeaderLoadDone()
                            // },3000)
                        var stylelists = $api.byId('allcommentS');
                        var htmls = '所有评论';
                        $api.html(stylelists, htmls);
                        var stylelist = $api.byId('comments');
                        var html = '';

                        for (var i = 0; i < ret.data.length; i++) {
                            var date = new Date(ret.data[i].create_date * 1000); //时间戳为10位需*1000，时间戳为13位的话不需乘1000
                            Y = date.getFullYear() + '年';
                            M = (date.getMonth() + 1 < 10 ? '0' + (date.getMonth() + 1) : date.getMonth() + 1) + '月';
                            D = (date.getDate() < 10 ? '0' + (date.getDate()) : date.getDate()) + '日';
                            var dates = Y + M + D;
                            if (ret.data[i].re_nick_name) {
                                html += '<div class="sec-discuss"><div class="dis-left fl"><div class="sec-img">';
                                if (ret.data[i].photo) {
                                    var photoss = ret.data[i].photo.substring(0, 4);
                                    if (photoss == 'http') {
                                        html += '<img src="' + ret.data[i].photo + '" alt="" onclick="fnOpenmyPersonal(' + ret.data[i].user_id + ', \'' + ret.data[i].nick_name + '\');">';
                                    } else {
                                        html += '<img src="' + updatePhotoUrl + ret.data[i].photo + '" alt="" onclick="fnOpenmyPersonal(' + ret.data[i].user_id + ', \'' + ret.data[i].nick_name + '\');">';
                                    }
                                } else {
                                    html += '<img src="../image/KM_tx.png" alt="" onclick="fnOpenmyPersonal(' + ret.data[i].user_id + ', \'' + ret.data[i].nick_name + '\');">';
                                }
                                html += '</div><div class="sec-txt"><p>' + ret.data[i].nick_name + '</p><p>' + dates +
                                    '</p></div></div><div class="dis-right fr"><div class="fr" id="commentExtraGood' + ret.data[i].comment_id + '"  class="collectmusicFxs">';
                                var commentaAlbumss = $api.getStorage('commentaAlbumBook_cExtraGood' + ret.data[i].comment_id + '');
                                if (!commentaAlbumss) {
                                    html += '<img src="../image/KM_ListingsListDzs.png" alt="" id="' + ret.data[i].comment_id + '" class="collectmusicFxs" onclick="collectmusicFx(this)" data-click="0">';

                                } else {
                                    if (commentaAlbumss != 'inc') {
                                        html += '<img src="../image/KM_ListingsListDzs.png" alt="" id="' + ret.data[i].comment_id + '" class="collectmusicFxs" onclick="collectmusicFx(this)" data-click="0">';
                                    } else {
                                        html += '<img src="../image/KM_play_dianzan_red.png" alt="" id="' + ret.data[i].comment_id + '" class="collectmusicFxs" onclick="collectmusicFx(this)" data-click="1">';
                                    }
                                }

                                html += '</div><div class="fr"><span id="corner_mark' + ret.data[i].comment_id + '">' + ret.data[i].good_total + '</span></div></div><div class="clear"></div><div class="dis-txt">' + ret.data[
                                        i].content + '</div><div class="reply"><div  onclick="fnOpenMessageNotDetail(' + ret.data[i].comment_id + ', \'' + ret.data[i].nick_name +
                                    '\')">回复</div></div><div class="discuss"><span ><span style="color:#538da4">' + ret.data[i].re_nick_name + '</span>:' + ret.data[i].re_content +
                                    '</span></div></div>';
                            } else {
                                html += '<div class="sec-discuss"><div class="dis-left fl"><div class="sec-img">';
                                if (ret.data[i].photo) {
                                    var photoss = ret.data[i].photo.substring(0, 4);
                                    if (photoss == 'http') {
                                        html += '<img src="' + ret.data[i].photo + '" alt="" onclick="fnOpenmyPersonal(' + ret.data[i].user_id + ', \'' + ret.data[i].nick_name + '\');">';
                                    } else {
                                        html += '<img src="' + updatePhotoUrl + ret.data[i].photo + '" alt="" onclick="fnOpenmyPersonal(' + ret.data[i].user_id + ', \'' + ret.data[i].nick_name + '\');">';
                                    }


                                } else {
                                    html += '<img src="../image/KM_tx.png" alt="" onclick="fnOpenmyPersonal(' + ret.data[i].user_id + ', \'' + ret.data[i].nick_name + '\');">';
                                }
                                html += '</div><div class="sec-txt"><p>' + ret.data[i].nick_name + '</p><p>' + dates +
                                    '</p></div></div><div class="dis-right fr"><div class="fr" id="commentExtraGood' + ret.data[i].comment_id + '"  class="collectmusicFxs">';
                                var commentaAlbumss = $api.getStorage('commentaAlbumBook_cExtraGood' + ret.data[i].comment_id + '');
                                if (!commentaAlbumss) {
                                    html += '<img src="../image/KM_ListingsListDzs.png" alt="" id="' + ret.data[i].comment_id + '" class="collectmusicFxs" onclick="collectmusicFx(this)" data-click="0">';

                                } else {
                                    if (commentaAlbumss != 'inc') {
                                        html += '<img src="../image/KM_ListingsListDzs.png" alt="" id="' + ret.data[i].comment_id + '" class="collectmusicFxs" onclick="collectmusicFx(this)" data-click="0">';
                                    } else {
                                        html += '<img src="../image/KM_play_dianzan_red.png" alt="" id="' + ret.data[i].comment_id + '" class="collectmusicFxs" onclick="collectmusicFx(this)" data-click="1">';
                                    }
                                }
                                html += '</div><div class="fr"><span id="corner_mark' + ret.data[i].comment_id + '">' + ret.data[i].good_total + '</span></div></div><div class="clear"></div><div class="dis-txt">' + ret.data[
                                    i].content + '</div><div class="reply"><div  onclick="fnOpenMessageNotDetail(' + ret.data[i].comment_id + ', \'' + ret.data[i].nick_name + '\')">回复</div></div></div>';
                            }
                        }
                        $api.html(stylelist, html);
                    }
                } else {
                    api.refreshHeaderLoadDone();
                    netMessage(ret);
                }
            } else {
                api.refreshHeaderLoadDone();
                netWork(err);
            }
        });
    }

    function ReplyToCommentsDiscuss_detail() {
      var token = $api.getStorage('token');
      if (token) {
        api.openWin({
            name: 'ReplyToCommentsDiscussDetailSingle',
            url: './ReplyToCommentsDiscuss_detail_single.html',
            pageParam: {
                soundId: soundId,
                uris: uris,
                name: name,
                ok: 'ReplyToCommentsDiscuss_detail_single'
            },
            reload: true
        });

      }else {
        api.openWin({
            name: 'token',
            url: './token.html',
            slidBackEnabled:false,
            reload: true,
            animation: {
             type:"none",
             subType:"from_right",
             duration:300
           },
        });
      }


    }

    function collectmusicFx(clicktoolitem) {

        var img_id = clicktoolitem.getAttribute("id");

        var toolbarlist = document.getElementById(img_id);
        var click = toolbarlist.getAttribute("data-click");
        var stylelist = $api.byId('corner_mark' + img_id + '');
        var conner_num = parseInt(stylelist.innerText);
        if (click == 0) {
            // 点开
            toolbarlist.setAttribute("data-click", 1);
            toolbarlist.src = "../image/KM_play_dianzan_red.png";
            uri = '/extra/good';
            api.ajax({
                url: host + apiUri + uri + '/' + img_id,
                method: 'post',
                dataType: 'json',
                timeout: 10,
                headers: {
                    "source": api.systemType,
                    "version": version,
                    "session": token
                },
                data: {
                    values: {
                        "type": 'inc',
                        "model": 'book_c',
                    },
                },
            }, function(ret, err) {
                if (ret) {
                    if (ret.status == 200) {
                        api.toast({              
                            msg:   '已点赞',
                            duration:  2000,
                            location:   'middle'          
                        });

                        conner_num++;
                        $api.html(stylelist, conner_num);
                        $api.setStorage('commentaAlbumBook_cExtraGood' + img_id + '', 'inc');
                        // $api.rmStorage('commentaAlbumExtraGood'+img_id+'');
                    } else {
                        netMessage(ret);
                    }
                } else {
                    netWork(err);
                }
            });
        } else {
            // 关闭
            toolbarlist.setAttribute("data-click", 0);
            toolbarlist.src = "../image/KM_ListingsListDzs.png";
            uri = '/extra/good';
            api.ajax({
                url: host + apiUri + uri + '/' + img_id,
                method: 'post',
                dataType: 'json',
                timeout: 10,
                headers: {
                    "source": api.systemType,
                    "version": version,
                    "session": token
                },
                data: {
                    values: {
                        "type": 'dec',
                        "model": 'book_c',
                    }
                }
            }, function(ret, err) {
                if (ret) {
                    if (ret.status == 200) {
                        api.toast({              
                            msg:   '已取消点赞',
                            duration:  2000,
                            location:   'middle'          
                        });
                        conner_num--;
                        if (conner_num < 0) {
                            conner_num = 0;
                        }
                        $api.html(stylelist, conner_num);
                        $api.setStorage('commentaAlbumBook_cExtraGood' + img_id + '', 'dec');
                    } else {
                        netMessage(ret);
                    }
                } else {
                    netWork(err);
                }
            });
        }
    }

    function fnOpenMessageNotDetail(comment_id, name) {
        api.openWin({
            name: 'replyDetailSingle',
            url: './reply_detail_single.html',
            pageParam: {
                comment_id: comment_id,
                soundId: soundId,
                uris: uris,
                name: name,
                ok: 'reply_detail_single'
            },
            bounces: false,
            vScrollBarEnabled: true,
            hScrollBarEnabled: true
        });
    }
</script>

</html>
